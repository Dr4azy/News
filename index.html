<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Sans CNews v3</title>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --accent: #ffd700; --text: #f0f0f0; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        
        header { background: #1a1a1a; padding: 15px; text-align: center; border-bottom: 2px solid var(--accent); position: sticky; top: 0; z-index: 1000; }
        
        .controls { padding: 10px; display: flex; flex-direction: column; gap: 8px; background: #1a1a1a; }
        .row { display: flex; gap: 5px; overflow-x: auto; }
        input, select, button { background: #2a2a2a; color: white; border: 1px solid #444; padding: 12px; border-radius: 8px; flex-grow: 1; }
        .btn-icon { flex-grow: 0; min-width: 45px; cursor: pointer; }
        .active-cat { background: var(--accent); color: black; }

        #grid { padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: var(--card); border-radius: 12px; overflow: hidden; position: relative; border: 1px solid #222; }
        .card img { width: 100%; height: 180px; object-fit: cover; background: #222; display: block; }
        .card-content { padding: 12px; }
        .card-title { font-weight: bold; margin-bottom: 8px; line-height: 1.3; }
        .card-footer { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; align-items: center; }
        
        .fav-btn { color: #555; font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .fav-btn.active { color: var(--accent); }

        /* Modal pour g√©rer les sources */
        #sourceModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; padding: 20px; }
        .source-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; }
    </style>
</head>
<body>

<header>
    <h1>les news sans cnews</h1>
</header>

<div class="controls">
    <div class="row">
        <input type="text" id="searchInput" placeholder="üîç Rechercher...">
        <button onclick="document.getElementById('sourceModal').style.display='block'" class="btn-icon">‚öôÔ∏è</button>
    </div>
    <div class="row">
        <select id="sourceSelect"><option value="Tous">Toutes les sources</option></select>
        <button id="favToggle" onclick="toggleShowFavs()" class="btn-icon">‚≠ê</button>
    </div>
</div>

<div id="grid"></div>

<div id="sourceModal">
    <h3>G√©rer mes flux RSS</h3>
    <input type="text" id="newSourceName" placeholder="Nom (ex: NASA)">
    <input type="text" id="newSourceUrl" placeholder="Lien RSS (XML)">
    <button onclick="addSource()" style="background: green; margin-top: 5px;">Ajouter</button>
    <div id="sourceList" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
    <button onclick="document.getElementById('sourceModal').style.display='none'" style="margin-top: 20px;">Fermer</button>
</div>

<script>
// --- INITIALISATION ---
let defaultSources = [
    { name: "Le Monde", url: "https://www.lemonde.fr/rss/une.xml" },
    { name: "NASA", url: "https://www.nasa.gov/rss/dyn/breaking_news.rss" }
];

let sources = JSON.parse(localStorage.getItem('news_sources')) || defaultSources;
let favorites = JSON.parse(localStorage.getItem('news_favs')) || [];
let allArticles = [];
let showOnlyFavs = false;

// --- MOTEUR DE REQU√äTE ---
async function fetchAll() {
    allArticles = [];
    document.getElementById('grid').innerHTML = "Chargement...";
    
    const promises = sources.map(s => 
        fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(s.url)}`)
        .then(r => r.json())
        .then(data => {
            if(data.status === 'ok') {
                data.items.forEach(item => {
                    allArticles.push({
                        id: item.guid || item.link,
                        title: item.title,
                        link: item.link,
                        img: item.enclosure.link || item.thumbnail || '',
                        source: s.name,
                        date: new Date(item.pubDate)
                    });
                });
            }
        }).catch(e => console.log(e))
    );

    await Promise.all(promises);
    allArticles.sort((a,b) => b.date - a.date);
    updateSourceSelect();
    render();
}

// --- AFFICHAGE ---
function render() {
    const grid = document.getElementById('grid');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const sourceFilter = document.getElementById('sourceSelect').value;

    let filtered = allArticles.filter(a => {
        const mSearch = a.title.toLowerCase().includes(search);
        const mSource = (sourceFilter === "Tous" || a.source === sourceFilter);
        const mFav = showOnlyFavs ? favorites.some(f => f.id === a.id) : true;
        return mSearch && mSource && mFav;
    });

    // Si on affiche les favoris et qu'on n'est pas en train de chercher dans les news fraiches
    if(showOnlyFavs) filtered = favorites;

    grid.innerHTML = filtered.map(a => `
        <div class="card">
            <a href="${a.link}" target="_blank" style="text-decoration:none; color:inherit;">
                <img src="${a.img}" onerror="this.src='https://via.placeholder.com/400x200/222/ffd700?text=${a.source}'">
                <div class="card-content">
                    <div class="card-title">${a.title}</div>
                </div>
            </a>
            <div class="card-content">
                <div class="card-footer">
                    <span>${a.source}</span>
                    <span class="fav-btn ${favorites.some(f => f.id === a.id) ? 'active' : ''}" onclick="toggleFav('${a.id.replace(/'/g, "\\'")}')">‚òÖ</span>
                </div>
            </div>
        </div>
    `).join('');
}

// --- LOGIQUE DES SOURCES ---
function updateSourceSelect() {
    const sel = document.getElementById('sourceSelect');
    const val = sel.value;
    sel.innerHTML = '<option value="Tous">Toutes les sources</option>';
    sources.forEach(s => {
        sel.innerHTML += `<option value="${s.name}">${s.name}</option>`;
    });
    sel.value = val;
    
    // Update List in Modal
    document.getElementById('sourceList').innerHTML = sources.map((s, i) => `
        <div class="source-item">
            <span>${s.name}</span>
            <button onclick="removeSource(${i})" style="padding:2px 8px; background:red;">X</button>
        </div>
    `).join('');
}

function addSource() {
    const name = document.getElementById('newSourceName').value;
    const url = document.getElementById('newSourceUrl').value;
    if(name && url) {
        sources.push({name, url});
        localStorage.setItem('news_sources', JSON.stringify(sources));
        fetchAll();
        document.getElementById('newSourceName').value = '';
        document.getElementById('newSourceUrl').value = '';
    }
}

function removeSource(i) {
    sources.splice(i, 1);
    localStorage.setItem('news_sources', JSON.stringify(sources));
    fetchAll();
}

// --- FAVORIS ---
function toggleFav(id) {
    const index = favorites.findIndex(f => f.id === id);
    if(index > -1) {
        favorites.splice(index, 1);
    } else {
        const art = allArticles.find(a => a.id === id);
        if(art) favorites.push(art);
    }
    localStorage.setItem('news_favs', JSON.stringify(favorites));
    render();
}

function toggleShowFavs() {
    showOnlyFavs = !showOnlyFavs;
    document.getElementById('favToggle').classList.toggle('active-cat', showOnlyFavs);
    render();
}

// --- EVENTS ---
document.getElementById('searchInput').addEventListener('input', render);
document.getElementById('sourceSelect').addEventListener('change', render);

fetchAll();
</script>
</body>
</html>
